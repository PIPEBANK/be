package com.pipebank.ordersystem.domain.erp.repository;

import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.pipebank.ordersystem.domain.erp.entity.ShipMast;

@Repository
public interface ShipMastRepository extends JpaRepository<ShipMast, ShipMast.ShipMastId> {

    /**
     * Í±∞ÎûòÏ≤òÎ≥Ñ Ï∂úÌïò ÎßàÏä§ÌÑ∞ Ï°∞Ìöå (ÌéòÏù¥Ïßï + ÌïÑÌÑ∞ÎßÅ)
     * ShipOrderÎ•º ÌÜµÌï¥ OrderMastÏôÄ Ï°∞Ïù∏ÌïòÏó¨ Ï∂úÍ≥†ÌòïÌÉú Ï†ïÎ≥¥ÎèÑ Ìï®Íªò Ï°∞Ìöå
     */
    @Query("""
        SELECT sm, om
        FROM ShipMast sm
        JOIN ShipOrder so ON sm.shipMastDate = so.shipOrderDate 
            AND sm.shipMastSosok = so.shipOrderSosok 
            AND sm.shipMastUjcd = so.shipOrderUjcd 
            AND sm.shipMastAcno = so.shipOrderAcno
        JOIN OrderMast om ON so.shipOrderOdate = om.orderMastDate 
            AND so.shipOrderSosok = om.orderMastSosok 
            AND so.shipOrderUjcd = om.orderMastUjcd 
            AND so.shipOrderOacno = om.orderMastAcno
        WHERE sm.shipMastCust = :custId
        AND (:shipDate IS NULL OR sm.shipMastDate = :shipDate)
        AND (:startDate IS NULL OR sm.shipMastDate >= :startDate)
        AND (:endDate IS NULL OR sm.shipMastDate <= :endDate)
        AND (:shipNumber IS NULL OR CONCAT(sm.shipMastDate, '-', sm.shipMastAcno) LIKE %:shipNumber%)
        AND (:sdiv IS NULL OR om.orderMastSdiv = :sdiv)
        AND (:comName IS NULL OR sm.shipMastComname LIKE %:comName%)
        ORDER BY sm.shipMastDate DESC, sm.shipMastAcno DESC
        """)
    Page<Object[]> findShipMastWithOrderMastByCustomerWithFilters(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("shipNumber") String shipNumber,
        @Param("sdiv") String sdiv,
        @Param("comName") String comName,
        Pageable pageable
    );

    /**
     * Ï∂úÌïòÏùºÏûêÏôÄ Ï∂úÌïòÎ≤àÌò∏Î°ú ShipMast Ï°∞Ìöå
     */
    @Query("""
        SELECT sm
        FROM ShipMast sm
        WHERE sm.shipMastDate = :shipDate
        AND sm.shipMastAcno = :shipAcno
        """)
    List<ShipMast> findByShipMastDateAndShipMastAcno(
        @Param("shipDate") String shipDate,
        @Param("shipAcno") Integer shipAcno
    );

    /**
     * Í±∞ÎûòÏ≤òÎ≥Ñ Ï∂úÍ≥†Ï†ÑÌëú Î™©Î°ù Ï°∞Ìöå (ÌéòÏù¥Ïßï + ÌïÑÌÑ∞ÎßÅ)
     * ShipOrderÎ•º ÌÜµÌï¥ OrderMastÏôÄ Ï°∞Ïù∏ÌïòÏó¨ Ï£ºÎ¨∏Î≤àÌò∏ Ï†ïÎ≥¥ÎèÑ Ìï®Íªò Ï°∞Ìöå
     */
    @Query("""
        SELECT sm, om
        FROM ShipMast sm
        JOIN ShipOrder so ON sm.shipMastDate = so.shipOrderDate 
            AND sm.shipMastSosok = so.shipOrderSosok 
            AND sm.shipMastUjcd = so.shipOrderUjcd 
            AND sm.shipMastAcno = so.shipOrderAcno
        JOIN OrderMast om ON so.shipOrderOdate = om.orderMastDate 
            AND so.shipOrderSosok = om.orderMastSosok 
            AND so.shipOrderUjcd = om.orderMastUjcd 
            AND so.shipOrderOacno = om.orderMastAcno
        WHERE sm.shipMastCust = :custId
        AND (:shipDate IS NULL OR sm.shipMastDate = :shipDate)
        AND (:startDate IS NULL OR sm.shipMastDate >= :startDate)
        AND (:endDate IS NULL OR sm.shipMastDate <= :endDate)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND (:shipNumber IS NULL OR CONCAT(sm.shipMastDate, '-', sm.shipMastAcno) LIKE %:shipNumber%)
        AND (:comName IS NULL OR sm.shipMastComname LIKE %:comName%)
        GROUP BY sm.shipMastDate, sm.shipMastSosok, sm.shipMastUjcd, sm.shipMastAcno,
                 om.orderMastDate, om.orderMastSosok, om.orderMastUjcd, om.orderMastAcno
        ORDER BY sm.shipMastDate DESC, sm.shipMastAcno DESC
        """)
    List<Object[]> findShipSlipListByCustomerWithFiltersNative(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("orderNumber") String orderNumber,
        @Param("shipNumber") String shipNumber,
        @Param("comName") String comName
    );

    /**
     * Í±∞ÎûòÏ≤òÎ≥Ñ ÌòÑÏû•Î≥Ñ Ï∂úÌïòÏ°∞Ìöå (ShipTran Îã®ÏúÑ) - ÌéòÏù¥Ïßï + ÌïÑÌÑ∞ÎßÅ
     * ShipMast ‚Üí ShipTran JOINÏúºÎ°ú Î™®Îì† Ï†úÌíàÎ≥Ñ Ï∂úÌïò Ï†ïÎ≥¥ Ï°∞Ìöå
     * ShipOrder ‚Üí OrderMast JOINÏúºÎ°ú Ï£ºÎ¨∏Î≤àÌò∏ ÌïÑÌÑ∞ÎßÅ ÏßÄÏõê
     */
    @Query("""
        SELECT sm, st, so, om
        FROM ShipMast sm
        JOIN ShipTran st ON sm.shipMastDate = st.shipTranDate 
            AND sm.shipMastSosok = st.shipTranSosok 
            AND sm.shipMastUjcd = st.shipTranUjcd 
            AND sm.shipMastAcno = st.shipTranAcno
        LEFT JOIN ShipOrder so ON sm.shipMastDate = so.shipOrderDate 
            AND sm.shipMastSosok = so.shipOrderSosok 
            AND sm.shipMastUjcd = so.shipOrderUjcd 
            AND sm.shipMastAcno = so.shipOrderAcno
            AND st.shipTranSeq = so.shipOrderSeq
        LEFT JOIN OrderMast om ON so.shipOrderOdate = om.orderMastDate 
            AND so.shipOrderSosok = om.orderMastSosok 
            AND so.shipOrderUjcd = om.orderMastUjcd 
            AND so.shipOrderOacno = om.orderMastAcno
        WHERE sm.shipMastCust = :custId
        AND (:shipDate IS NULL OR st.shipTranDate = :shipDate)
        AND (:startDate IS NULL OR st.shipTranDate >= :startDate)
        AND (:endDate IS NULL OR st.shipTranDate <= :endDate)
        AND (:shipNumber IS NULL OR CONCAT(sm.shipMastDate, '-', sm.shipMastAcno) LIKE %:shipNumber%)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND (:itemName IS NULL OR st.shipTranDeta LIKE %:itemName%)
        AND (:comName IS NULL OR sm.shipMastComname LIKE %:comName%)
        ORDER BY st.shipTranDate DESC, sm.shipMastDate DESC, sm.shipMastAcno DESC, st.shipTranSeq ASC
        """)
    Page<Object[]> findShipmentItemsByCustomerWithFilters(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("shipNumber") String shipNumber,
        @Param("orderNumber") String orderNumber,
        @Param("itemName") String itemName,
        @Param("comName") String comName,
        Pageable pageable
    );

    // üî• Ï†úÌíàÎ™Ö AND, Í∑úÍ≤© AND
    @Query("""
        SELECT sm, st, so, om
        FROM ShipMast sm
        JOIN ShipTran st ON sm.shipMastDate = st.shipTranDate 
            AND sm.shipMastSosok = st.shipTranSosok 
            AND sm.shipMastUjcd = st.shipTranUjcd 
            AND sm.shipMastAcno = st.shipTranAcno
        LEFT JOIN ShipOrder so ON sm.shipMastDate = so.shipOrderDate 
            AND sm.shipMastSosok = so.shipOrderSosok 
            AND sm.shipMastUjcd = so.shipOrderUjcd 
            AND sm.shipMastAcno = so.shipOrderAcno
            AND st.shipTranSeq = so.shipOrderSeq
        LEFT JOIN OrderMast om ON so.shipOrderOdate = om.orderMastDate 
            AND so.shipOrderSosok = om.orderMastSosok 
            AND so.shipOrderUjcd = om.orderMastUjcd 
            AND so.shipOrderOacno = om.orderMastAcno
        WHERE sm.shipMastCust = :custId
        AND (:shipDate IS NULL OR st.shipTranDate = :shipDate)
        AND (:startDate IS NULL OR st.shipTranDate >= :startDate)
        AND (:endDate IS NULL OR st.shipTranDate <= :endDate)
        AND (:shipNumber IS NULL OR CONCAT(sm.shipMastDate, '-', sm.shipMastAcno) LIKE %:shipNumber%)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND (:itemName1 IS NULL OR :itemName1 = '' OR st.shipTranDeta LIKE %:itemName1%)
        AND (:itemName2 IS NULL OR :itemName2 = '' OR st.shipTranDeta LIKE %:itemName2%)
        AND (:spec1 IS NULL OR :spec1 = '' OR st.shipTranSpec LIKE %:spec1%)
        AND (:spec2 IS NULL OR :spec2 = '' OR st.shipTranSpec LIKE %:spec2%)
        AND (:comName IS NULL OR sm.shipMastComname LIKE %:comName%)
        ORDER BY st.shipTranDate DESC, sm.shipMastDate DESC, sm.shipMastAcno DESC, st.shipTranSeq ASC
        """)
    Page<Object[]> findShipmentItemsByCustomerWithFiltersAndAnd(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("shipNumber") String shipNumber,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("comName") String comName,
        Pageable pageable
    );

    // üî• Ï†úÌíàÎ™Ö OR, Í∑úÍ≤© AND
    @Query("""
        SELECT sm, st, so, om
        FROM ShipMast sm
        JOIN ShipTran st ON sm.shipMastDate = st.shipTranDate 
            AND sm.shipMastSosok = st.shipTranSosok 
            AND sm.shipMastUjcd = st.shipTranUjcd 
            AND sm.shipMastAcno = st.shipTranAcno
        LEFT JOIN ShipOrder so ON sm.shipMastDate = so.shipOrderDate 
            AND sm.shipMastSosok = so.shipOrderSosok 
            AND sm.shipMastUjcd = so.shipOrderUjcd 
            AND sm.shipMastAcno = so.shipOrderAcno
            AND st.shipTranSeq = so.shipOrderSeq
        LEFT JOIN OrderMast om ON so.shipOrderOdate = om.orderMastDate 
            AND so.shipOrderSosok = om.orderMastSosok 
            AND so.shipOrderUjcd = om.orderMastUjcd 
            AND so.shipOrderOacno = om.orderMastAcno
        WHERE sm.shipMastCust = :custId
        AND (:shipDate IS NULL OR st.shipTranDate = :shipDate)
        AND (:startDate IS NULL OR st.shipTranDate >= :startDate)
        AND (:endDate IS NULL OR st.shipTranDate <= :endDate)
        AND (:shipNumber IS NULL OR CONCAT(sm.shipMastDate, '-', sm.shipMastAcno) LIKE %:shipNumber%)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND ((:itemName1 IS NULL OR :itemName1 = '' OR st.shipTranDeta LIKE %:itemName1%) OR 
             (:itemName2 IS NULL OR :itemName2 = '' OR st.shipTranDeta LIKE %:itemName2%))
        AND (:spec1 IS NULL OR :spec1 = '' OR st.shipTranSpec LIKE %:spec1%)
        AND (:spec2 IS NULL OR :spec2 = '' OR st.shipTranSpec LIKE %:spec2%)
        AND (:comName IS NULL OR sm.shipMastComname LIKE %:comName%)
        ORDER BY st.shipTranDate DESC, sm.shipMastDate DESC, sm.shipMastAcno DESC, st.shipTranSeq ASC
        """)
    Page<Object[]> findShipmentItemsByCustomerWithFiltersOrAnd(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("shipNumber") String shipNumber,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("comName") String comName,
        Pageable pageable
    );

    // üî• Ï†úÌíàÎ™Ö AND, Í∑úÍ≤© OR
    @Query("""
        SELECT sm, st, so, om
        FROM ShipMast sm
        JOIN ShipTran st ON sm.shipMastDate = st.shipTranDate 
            AND sm.shipMastSosok = st.shipTranSosok 
            AND sm.shipMastUjcd = st.shipTranUjcd 
            AND sm.shipMastAcno = st.shipTranAcno
        LEFT JOIN ShipOrder so ON sm.shipMastDate = so.shipOrderDate 
            AND sm.shipMastSosok = so.shipOrderSosok 
            AND sm.shipMastUjcd = so.shipOrderUjcd 
            AND sm.shipMastAcno = so.shipOrderAcno
            AND st.shipTranSeq = so.shipOrderSeq
        LEFT JOIN OrderMast om ON so.shipOrderOdate = om.orderMastDate 
            AND so.shipOrderSosok = om.orderMastSosok 
            AND so.shipOrderUjcd = om.orderMastUjcd 
            AND so.shipOrderOacno = om.orderMastAcno
        WHERE sm.shipMastCust = :custId
        AND (:shipDate IS NULL OR st.shipTranDate = :shipDate)
        AND (:startDate IS NULL OR st.shipTranDate >= :startDate)
        AND (:endDate IS NULL OR st.shipTranDate <= :endDate)
        AND (:shipNumber IS NULL OR CONCAT(sm.shipMastDate, '-', sm.shipMastAcno) LIKE %:shipNumber%)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND (:itemName1 IS NULL OR :itemName1 = '' OR st.shipTranDeta LIKE %:itemName1%)
        AND (:itemName2 IS NULL OR :itemName2 = '' OR st.shipTranDeta LIKE %:itemName2%)
        AND ((:spec1 IS NULL OR :spec1 = '' OR st.shipTranSpec LIKE %:spec1%) OR 
             (:spec2 IS NULL OR :spec2 = '' OR st.shipTranSpec LIKE %:spec2%))
        AND (:comName IS NULL OR sm.shipMastComname LIKE %:comName%)
        ORDER BY st.shipTranDate DESC, sm.shipMastDate DESC, sm.shipMastAcno DESC, st.shipTranSeq ASC
        """)
    Page<Object[]> findShipmentItemsByCustomerWithFiltersAndOr(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("shipNumber") String shipNumber,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("comName") String comName,
        Pageable pageable
    );

    // üî• Ï†úÌíàÎ™Ö OR, Í∑úÍ≤© OR
    @Query("""
        SELECT sm, st, so, om
        FROM ShipMast sm
        JOIN ShipTran st ON sm.shipMastDate = st.shipTranDate 
            AND sm.shipMastSosok = st.shipTranSosok 
            AND sm.shipMastUjcd = st.shipTranUjcd 
            AND sm.shipMastAcno = st.shipTranAcno
        LEFT JOIN ShipOrder so ON sm.shipMastDate = so.shipOrderDate 
            AND sm.shipMastSosok = so.shipOrderSosok 
            AND sm.shipMastUjcd = so.shipOrderUjcd 
            AND sm.shipMastAcno = so.shipOrderAcno
            AND st.shipTranSeq = so.shipOrderSeq
        LEFT JOIN OrderMast om ON so.shipOrderOdate = om.orderMastDate 
            AND so.shipOrderSosok = om.orderMastSosok 
            AND so.shipOrderUjcd = om.orderMastUjcd 
            AND so.shipOrderOacno = om.orderMastAcno
        WHERE sm.shipMastCust = :custId
        AND (:shipDate IS NULL OR st.shipTranDate = :shipDate)
        AND (:startDate IS NULL OR st.shipTranDate >= :startDate)
        AND (:endDate IS NULL OR st.shipTranDate <= :endDate)
        AND (:shipNumber IS NULL OR CONCAT(sm.shipMastDate, '-', sm.shipMastAcno) LIKE %:shipNumber%)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND ((:itemName1 IS NULL OR :itemName1 = '' OR st.shipTranDeta LIKE %:itemName1%) OR 
             (:itemName2 IS NULL OR :itemName2 = '' OR st.shipTranDeta LIKE %:itemName2%))
        AND ((:spec1 IS NULL OR :spec1 = '' OR st.shipTranSpec LIKE %:spec1%) OR 
             (:spec2 IS NULL OR :spec2 = '' OR st.shipTranSpec LIKE %:spec2%))
        AND (:comName IS NULL OR sm.shipMastComname LIKE %:comName%)
        ORDER BY st.shipTranDate DESC, sm.shipMastDate DESC, sm.shipMastAcno DESC, st.shipTranSeq ASC
        """)
    Page<Object[]> findShipmentItemsByCustomerWithFiltersOrOr(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("shipNumber") String shipNumber,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("comName") String comName,
        Pageable pageable
    );

    // üî• ÌïòÏúÑÌò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú default Î©îÏÑúÎìú
    default Page<Object[]> findShipmentItemsByCustomerWithFilters(
            Integer custId, String shipDate, String startDate, String endDate,
            String shipNumber, String orderNumber, String itemName1, String itemName2,
            String spec1, String spec2, String itemNameOperator, String specOperator,
            String comName, Pageable pageable) {
        
        boolean itemNameIsOr = "OR".equalsIgnoreCase(itemNameOperator);
        boolean specIsOr = "OR".equalsIgnoreCase(specOperator);

        if (!itemNameIsOr && !specIsOr) {
            // AND, AND
            return findShipmentItemsByCustomerWithFiltersAndAnd(
                custId, shipDate, startDate, endDate, shipNumber, orderNumber,
                itemName1, itemName2, spec1, spec2, comName, pageable);
        } else if (itemNameIsOr && !specIsOr) {
            // OR, AND
            return findShipmentItemsByCustomerWithFiltersOrAnd(
                custId, shipDate, startDate, endDate, shipNumber, orderNumber,
                itemName1, itemName2, spec1, spec2, comName, pageable);
        } else if (!itemNameIsOr && specIsOr) {
            // AND, OR
            return findShipmentItemsByCustomerWithFiltersAndOr(
                custId, shipDate, startDate, endDate, shipNumber, orderNumber,
                itemName1, itemName2, spec1, spec2, comName, pageable);
        } else {
            // OR, OR
            return findShipmentItemsByCustomerWithFiltersOrOr(
                custId, shipDate, startDate, endDate, shipNumber, orderNumber,
                itemName1, itemName2, spec1, spec2, comName, pageable);
        }
    }

    /**
     * üî• Ï£ºÎ¨∏-Ï∂úÌïò ÌÜµÌï© ÏÉÅÏÑ∏ Ï°∞Ìöå (ÌéòÏù¥Ïßï + 2Ï§ë ÌïÑÌÑ∞ÎßÅ)
     * OrderMast + OrderTran + ItemCode + ShipTran ÌÜµÌï© Ï°∞Ìöå
     * 
     * @param custId Í±∞ÎûòÏ≤òID (ORDER_MAST_CUST Í∏∞Ï§Ä)
     * @param shipDate Ï∂úÌïòÏùºÏûê (Ï†ïÌôï ÏùºÏπò)
     * @param startDate ÏãúÏûëÏùºÏûê (Î≤îÏúÑ Ï°∞Ìöå)
     * @param endDate Ï¢ÖÎ£åÏùºÏûê (Î≤îÏúÑ Ï°∞Ìöå)
     * @param orderNumber Ï£ºÎ¨∏Î≤àÌò∏ (Î∂ÄÎ∂Ñ Í≤ÄÏÉâ)
     * @param itemName1 ÌíàÎ™Ö1 (Î∂ÄÎ∂Ñ Í≤ÄÏÉâ)
     * @param itemName2 ÌíàÎ™Ö2 (Î∂ÄÎ∂Ñ Í≤ÄÏÉâ)
     * @param spec1 Í∑úÍ≤©1 (Î∂ÄÎ∂Ñ Í≤ÄÏÉâ)
     * @param spec2 Í∑úÍ≤©2 (Î∂ÄÎ∂Ñ Í≤ÄÏÉâ)
     * @param itemNameOperator ÌíàÎ™Ö Í≤ÄÏÉâ Ïó∞ÏÇ∞Ïûê (AND/OR)
     * @param specOperator Í∑úÍ≤© Í≤ÄÏÉâ Ïó∞ÏÇ∞Ïûê (AND/OR)
     * @param siteName ÌòÑÏû•Î™Ö (Î∂ÄÎ∂Ñ Í≤ÄÏÉâ)
     * @param excludeCompleted ÏôÑÎ£å ÎÇ¥Ïó≠ Ï†úÏô∏ Ïó¨Î∂Ä
     * @param statusFilter ÌäπÏ†ï ÏÉÅÌÉúÎßå Ï°∞Ìöå
     * @param pageable ÌéòÏù¥Ïßï Ï†ïÎ≥¥
     * @return ÌÜµÌï© Ï°∞Ìöå Í≤∞Í≥º (17Í∞ú ÌïÑÎìú)
     */
    default Page<Object[]> findOrderShipmentDetailByCustomer(
            Integer custId, String shipDate, String startDate, String endDate, String orderNumber,
            String itemName1, String itemName2, String spec1, String spec2,
            String itemNameOperator, String specOperator, String siteName,
            boolean excludeCompleted, String statusFilter, Pageable pageable) {
        
        // ÌíàÎ™Ö Ïó∞ÏÇ∞ÏûêÏóê Îî∞Î•∏ Î∂ÑÍ∏∞
        boolean itemNameAnd = "AND".equalsIgnoreCase(itemNameOperator);
        boolean specAnd = "AND".equalsIgnoreCase(specOperator);
        
        if (itemNameAnd && specAnd) {
            // AND, AND
            return findOrderShipmentDetailByCustomerAndAnd(
                custId, shipDate, startDate, endDate, orderNumber,
                itemName1, itemName2, spec1, spec2, siteName, excludeCompleted, statusFilter, pageable);
        } else if (!itemNameAnd && specAnd) {
            // OR, AND
            return findOrderShipmentDetailByCustomerOrAnd(
                custId, shipDate, startDate, endDate, orderNumber,
                itemName1, itemName2, spec1, spec2, siteName, excludeCompleted, statusFilter, pageable);
        } else if (itemNameAnd && !specAnd) {
            // AND, OR
            return findOrderShipmentDetailByCustomerAndOr(
                custId, shipDate, startDate, endDate, orderNumber,
                itemName1, itemName2, spec1, spec2, siteName, excludeCompleted, statusFilter, pageable);
        } else {
            // OR, OR
            return findOrderShipmentDetailByCustomerOrOr(
                custId, shipDate, startDate, endDate, orderNumber,
                itemName1, itemName2, spec1, spec2, siteName, excludeCompleted, statusFilter, pageable);
        }
    }

    // üî• ÌíàÎ™Ö AND, Í∑úÍ≤© AND
    @Query("""
        SELECT 
            om.orderMastDate,
            om.orderMastAcno,
            om.orderMastOdate,
            ot.orderTranStau,
            ic.itemCodeNum,
            ot.orderTranDeta,
            ot.orderTranSpec,
            ot.orderTranUnit,
            om.orderMastComname,
            om.orderMastDcust,
            ot.orderTranCnt,
            ot.orderTranAmt,
            ot.orderTranDcPer,
            ot.orderTranTot,
            COALESCE(SUM(st.shipTranCnt), 0),
            cc3.commCod3Hnam
        FROM OrderMast om
        INNER JOIN OrderTran ot ON om.orderMastDate = ot.orderTranDate 
            AND om.orderMastSosok = ot.orderTranSosok 
            AND om.orderMastUjcd = ot.orderTranUjcd 
            AND om.orderMastAcno = ot.orderTranAcno
        LEFT JOIN ItemCode ic ON ot.orderTranItem = ic.itemCodeCode
        LEFT JOIN ShipOrder so ON ot.orderTranDate = so.shipOrderOdate 
            AND ot.orderTranSosok = so.shipOrderSosok 
            AND ot.orderTranUjcd = so.shipOrderUjcd 
            AND ot.orderTranAcno = so.shipOrderOacno 
            AND ot.orderTranSeq = so.shipOrderOseq
        LEFT JOIN ShipTran st ON so.shipOrderDate = st.shipTranDate 
            AND so.shipOrderSosok = st.shipTranSosok 
            AND so.shipOrderUjcd = st.shipTranUjcd 
            AND so.shipOrderAcno = st.shipTranAcno 
            AND so.shipOrderSeq = st.shipTranSeq
        LEFT JOIN CommonCode3 cc3 ON ot.orderTranStau = cc3.commCod3Code
        WHERE om.orderMastCust = :custId
        AND (:shipDate IS NULL OR om.orderMastDate = :shipDate)
        AND (:startDate IS NULL OR om.orderMastDate >= :startDate)
        AND (:endDate IS NULL OR om.orderMastDate <= :endDate)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND (:itemName1 IS NULL OR ot.orderTranDeta LIKE %:itemName1%)
        AND (:itemName2 IS NULL OR ot.orderTranDeta LIKE %:itemName2%)
        AND (:spec1 IS NULL OR ot.orderTranSpec LIKE %:spec1%)
        AND (:spec2 IS NULL OR ot.orderTranSpec LIKE %:spec2%)
        AND (:siteName IS NULL OR om.orderMastComname LIKE %:siteName%)
        AND (:excludeCompleted = false OR ot.orderTranStau != '4010030001')
        AND (:statusFilter IS NULL OR ot.orderTranStau = :statusFilter)
        GROUP BY om.orderMastDate, om.orderMastAcno, ot.orderTranSeq,
                 om.orderMastOdate, ot.orderTranStau, ic.itemCodeNum, 
                 ot.orderTranDeta, ot.orderTranSpec, ot.orderTranUnit,
                 om.orderMastComname, om.orderMastDcust, ot.orderTranCnt, 
                 ot.orderTranAmt, ot.orderTranDcPer, ot.orderTranTot, cc3.commCod3Hnam
        """)
    Page<Object[]> findOrderShipmentDetailByCustomerAndAnd(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("siteName") String siteName,
        @Param("excludeCompleted") boolean excludeCompleted,
        @Param("statusFilter") String statusFilter,
        Pageable pageable
    );

    // üî• ÌíàÎ™Ö OR, Í∑úÍ≤© AND
    @Query("""
        SELECT 
            om.orderMastDate, om.orderMastAcno, om.orderMastOdate, ot.orderTranStau,
            ic.itemCodeNum, ot.orderTranDeta, ot.orderTranSpec, ot.orderTranUnit,
            om.orderMastComname, om.orderMastDcust, ot.orderTranCnt, ot.orderTranAmt, 
            ot.orderTranDcPer, ot.orderTranTot, COALESCE(SUM(st.shipTranCnt), 0), cc3.commCod3Hnam
        FROM OrderMast om
        INNER JOIN OrderTran ot ON om.orderMastDate = ot.orderTranDate 
            AND om.orderMastSosok = ot.orderTranSosok 
            AND om.orderMastUjcd = ot.orderTranUjcd 
            AND om.orderMastAcno = ot.orderTranAcno
        LEFT JOIN ItemCode ic ON ot.orderTranItem = ic.itemCodeCode
        LEFT JOIN ShipOrder so ON ot.orderTranDate = so.shipOrderOdate 
            AND ot.orderTranSosok = so.shipOrderSosok 
            AND ot.orderTranUjcd = so.shipOrderUjcd 
            AND ot.orderTranAcno = so.shipOrderOacno 
            AND ot.orderTranSeq = so.shipOrderOseq
        LEFT JOIN ShipTran st ON so.shipOrderDate = st.shipTranDate 
            AND so.shipOrderSosok = st.shipTranSosok 
            AND so.shipOrderUjcd = st.shipTranUjcd 
            AND so.shipOrderAcno = st.shipTranAcno 
            AND so.shipOrderSeq = st.shipTranSeq
        LEFT JOIN CommonCode3 cc3 ON ot.orderTranStau = cc3.commCod3Code
        WHERE om.orderMastCust = :custId
        AND (:shipDate IS NULL OR om.orderMastDate = :shipDate)
        AND (:startDate IS NULL OR om.orderMastDate >= :startDate)
        AND (:endDate IS NULL OR om.orderMastDate <= :endDate)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND ((:itemName1 IS NULL OR ot.orderTranDeta LIKE %:itemName1%) 
             OR (:itemName2 IS NULL OR ot.orderTranDeta LIKE %:itemName2%))
        AND (:spec1 IS NULL OR ot.orderTranSpec LIKE %:spec1%)
        AND (:spec2 IS NULL OR ot.orderTranSpec LIKE %:spec2%)
        AND (:siteName IS NULL OR om.orderMastComname LIKE %:siteName%)
        AND (:excludeCompleted = false OR ot.orderTranStau != '4010030001')
        AND (:statusFilter IS NULL OR ot.orderTranStau = :statusFilter)
        GROUP BY om.orderMastDate, om.orderMastAcno, ot.orderTranSeq,
                 om.orderMastOdate, ot.orderTranStau, ic.itemCodeNum, 
                 ot.orderTranDeta, ot.orderTranSpec, ot.orderTranUnit,
                 om.orderMastComname, om.orderMastDcust, ot.orderTranCnt, 
                 ot.orderTranAmt, ot.orderTranDcPer, ot.orderTranTot, cc3.commCod3Hnam
        """)
    Page<Object[]> findOrderShipmentDetailByCustomerOrAnd(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("siteName") String siteName,
        @Param("excludeCompleted") boolean excludeCompleted,
        @Param("statusFilter") String statusFilter,
        Pageable pageable
    );

    // üî• ÌíàÎ™Ö AND, Í∑úÍ≤© OR
    @Query("""
        SELECT 
            om.orderMastDate, om.orderMastAcno, om.orderMastOdate, ot.orderTranStau,
            ic.itemCodeNum, ot.orderTranDeta, ot.orderTranSpec, ot.orderTranUnit,
            om.orderMastComname, om.orderMastDcust, ot.orderTranCnt, ot.orderTranAmt, 
            ot.orderTranDcPer, ot.orderTranTot, COALESCE(SUM(st.shipTranCnt), 0), cc3.commCod3Hnam
        FROM OrderMast om
        INNER JOIN OrderTran ot ON om.orderMastDate = ot.orderTranDate 
            AND om.orderMastSosok = ot.orderTranSosok 
            AND om.orderMastUjcd = ot.orderTranUjcd 
            AND om.orderMastAcno = ot.orderTranAcno
        LEFT JOIN ItemCode ic ON ot.orderTranItem = ic.itemCodeCode
        LEFT JOIN ShipOrder so ON ot.orderTranDate = so.shipOrderOdate 
            AND ot.orderTranSosok = so.shipOrderSosok 
            AND ot.orderTranUjcd = so.shipOrderUjcd 
            AND ot.orderTranAcno = so.shipOrderOacno 
            AND ot.orderTranSeq = so.shipOrderOseq
        LEFT JOIN ShipTran st ON so.shipOrderDate = st.shipTranDate 
            AND so.shipOrderSosok = st.shipTranSosok 
            AND so.shipOrderUjcd = st.shipTranUjcd 
            AND so.shipOrderAcno = st.shipTranAcno 
            AND so.shipOrderSeq = st.shipTranSeq
        LEFT JOIN CommonCode3 cc3 ON ot.orderTranStau = cc3.commCod3Code
        WHERE om.orderMastCust = :custId
        AND (:shipDate IS NULL OR om.orderMastDate = :shipDate)
        AND (:startDate IS NULL OR om.orderMastDate >= :startDate)
        AND (:endDate IS NULL OR om.orderMastDate <= :endDate)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND (:itemName1 IS NULL OR ot.orderTranDeta LIKE %:itemName1%)
        AND (:itemName2 IS NULL OR ot.orderTranDeta LIKE %:itemName2%)
        AND ((:spec1 IS NULL OR ot.orderTranSpec LIKE %:spec1%) 
             OR (:spec2 IS NULL OR ot.orderTranSpec LIKE %:spec2%))
        AND (:siteName IS NULL OR om.orderMastComname LIKE %:siteName%)
        AND (:excludeCompleted = false OR ot.orderTranStau != '4010030001')
        AND (:statusFilter IS NULL OR ot.orderTranStau = :statusFilter)
        GROUP BY om.orderMastDate, om.orderMastAcno, ot.orderTranSeq,
                 om.orderMastOdate, ot.orderTranStau, ic.itemCodeNum, 
                 ot.orderTranDeta, ot.orderTranSpec, ot.orderTranUnit,
                 om.orderMastComname, om.orderMastDcust, ot.orderTranCnt, 
                 ot.orderTranAmt, ot.orderTranDcPer, ot.orderTranTot, cc3.commCod3Hnam
        """)
    Page<Object[]> findOrderShipmentDetailByCustomerAndOr(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("siteName") String siteName,
        @Param("excludeCompleted") boolean excludeCompleted,
        @Param("statusFilter") String statusFilter,
        Pageable pageable
    );

    // üî• ÌíàÎ™Ö OR, Í∑úÍ≤© OR
    @Query("""
        SELECT 
            om.orderMastDate, om.orderMastAcno, om.orderMastOdate, ot.orderTranStau,
            ic.itemCodeNum, ot.orderTranDeta, ot.orderTranSpec, ot.orderTranUnit,
            om.orderMastComname, om.orderMastDcust, ot.orderTranCnt, ot.orderTranAmt, 
            ot.orderTranDcPer, ot.orderTranTot, COALESCE(SUM(st.shipTranCnt), 0), cc3.commCod3Hnam
        FROM OrderMast om
        INNER JOIN OrderTran ot ON om.orderMastDate = ot.orderTranDate 
            AND om.orderMastSosok = ot.orderTranSosok 
            AND om.orderMastUjcd = ot.orderTranUjcd 
            AND om.orderMastAcno = ot.orderTranAcno
        LEFT JOIN ItemCode ic ON ot.orderTranItem = ic.itemCodeCode
        LEFT JOIN ShipOrder so ON ot.orderTranDate = so.shipOrderOdate 
            AND ot.orderTranSosok = so.shipOrderSosok 
            AND ot.orderTranUjcd = so.shipOrderUjcd 
            AND ot.orderTranAcno = so.shipOrderOacno 
            AND ot.orderTranSeq = so.shipOrderOseq
        LEFT JOIN ShipTran st ON so.shipOrderDate = st.shipTranDate 
            AND so.shipOrderSosok = st.shipTranSosok 
            AND so.shipOrderUjcd = st.shipTranUjcd 
            AND so.shipOrderAcno = st.shipTranAcno 
            AND so.shipOrderSeq = st.shipTranSeq
        LEFT JOIN CommonCode3 cc3 ON ot.orderTranStau = cc3.commCod3Code
        WHERE om.orderMastCust = :custId
        AND (:shipDate IS NULL OR om.orderMastDate = :shipDate)
        AND (:startDate IS NULL OR om.orderMastDate >= :startDate)
        AND (:endDate IS NULL OR om.orderMastDate <= :endDate)
        AND (:orderNumber IS NULL OR CONCAT(om.orderMastDate, '-', om.orderMastAcno) LIKE %:orderNumber%)
        AND ((:itemName1 IS NULL OR ot.orderTranDeta LIKE %:itemName1%) 
             OR (:itemName2 IS NULL OR ot.orderTranDeta LIKE %:itemName2%))
        AND ((:spec1 IS NULL OR ot.orderTranSpec LIKE %:spec1%) 
             OR (:spec2 IS NULL OR ot.orderTranSpec LIKE %:spec2%))
        AND (:siteName IS NULL OR om.orderMastComname LIKE %:siteName%)
        AND (:excludeCompleted = false OR ot.orderTranStau != '4010030001')
        AND (:statusFilter IS NULL OR ot.orderTranStau = :statusFilter)
        GROUP BY om.orderMastDate, om.orderMastAcno, ot.orderTranSeq,
                 om.orderMastOdate, ot.orderTranStau, ic.itemCodeNum, 
                 ot.orderTranDeta, ot.orderTranSpec, ot.orderTranUnit,
                 om.orderMastComname, om.orderMastDcust, ot.orderTranCnt, 
                 ot.orderTranAmt, ot.orderTranDcPer, ot.orderTranTot, cc3.commCod3Hnam
        """)
    Page<Object[]> findOrderShipmentDetailByCustomerOrOr(
        @Param("custId") Integer custId,
        @Param("shipDate") String shipDate,
        @Param("startDate") String startDate,
        @Param("endDate") String endDate,
        @Param("orderNumber") String orderNumber,
        @Param("itemName1") String itemName1,
        @Param("itemName2") String itemName2,
        @Param("spec1") String spec1,
        @Param("spec2") String spec2,
        @Param("siteName") String siteName,
        @Param("excludeCompleted") boolean excludeCompleted,
        @Param("statusFilter") String statusFilter,
        Pageable pageable
    );
} 